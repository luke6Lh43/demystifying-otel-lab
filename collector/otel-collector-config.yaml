receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318
  filelog:
    include: [ /logs/legacy.log ]
    start_at: end
    storage: file_storage
    poll_interval: 5s
    operators:
      # --- STEP 1: Generic Parsing ---
      # Captures Timestamp, Event, Line, and puts the rest into 'params'
      - type: regex_parser
        regex: '^(?P<timestamp>.+?) \| (?P<event_type>[A-Z_]+): (?P<line>Line\d+)(?:, (?P<params>.*))?'
        timestamp:
          parse_from: attributes.timestamp
          layout: '%Y-%m-%d %H:%M:%S'

      # --- STEP 2: Extract Fault Only ---
      # Look specifically for "Fault=Something" inside the 'params' attribute
      - type: regex_parser
        regex: 'Fault=(?P<fault>\w+)'
        parse_from: attributes.params
        if: 'attributes.params != nil'

  sqlserver/sql1:
    collection_interval: 30s
    username: sa
    password: YourStrong!Passw0rd
    server: sql-server-1
    port: 1433

  sqlserver/sql2:
    collection_interval: 30s
    username: sa
    password: YourStrong!Passw0rd
    server: sql-server-2
    port: 1433

connectors:
  count:
    logs:
      machine_events_total:
        description: "Count of manufacturing events by type, line, and fault."
        attributes:
          - key: event_type
            default_value: "unknown"
          - key: line
            default_value: "unknown"
          - key: fault
            default_value: "none" 

processors:
  # Clean up attributes before counting
  transform:
    error_mode: ignore
    log_statements:
      - context: log
        statements:
          # If no fault was found (e.g., PRODUCT_COMPLETED), explicitly set it to "none"
          # This ensures the metric label exists and is consistent.
          - set(attributes["fault"], "none") where attributes["fault"] == nil

  deltatocumulative:
    max_stale: 5m
    max_streams: 1000

extensions:
  file_storage:
    directory: /var/lib/otelcol

exporters:
  debug:
    verbosity: detailed
  prometheus:
    endpoint: "0.0.0.0:8889"
    resource_to_telemetry_conversion:
      enabled: true
  otlp/jaeger:
    endpoint: "jaeger:4317"
    tls:
      insecure: true

service:
  extensions: [file_storage]
  pipelines:
    logs:
      receivers: [filelog]
      processors: [transform]
      exporters: [count, debug]
    
    metrics/generated:
      receivers: [count]
      processors: [deltatocumulative]
      exporters: [prometheus, debug]

    metrics/regular:
      receivers: [otlp, sqlserver/sql1, sqlserver/sql2]
      exporters: [prometheus, debug]
    traces:
      receivers: [otlp]
      exporters: [debug, otlp/jaeger]